import { Code } from "astro:components";

# Core Concepts

Cereb is built around a few core abstractions that work together to provide a powerful yet lightweight gesture handling system.

## Signal

A **Signal** is an immutable data container representing a single event at a point in time. Every pointer move, touch start, or gesture change produces a Signal.

```typescript
interface Signal<K extends string, V> {
  readonly kind: K;        // Type identifier (e.g., "single-pointer", "pan")
  readonly value: V;       // The actual event data
  readonly deviceId: string;
  readonly createdAt: number;
}
```

## Stream

A **Stream** is an observable sequence of Signals over time. It's the pipeline through which all events flow.

```typescript
interface Stream<T extends Signal> {
  on(observer: (value: T) => void): Unsubscribe;
  block(): void;
  unblock(): void;
  readonly isBlocked: boolean;
}
```

### Key Characteristics

- **Lazy** - No work happens until you call `on()`
- **Unicast by default** - Each subscription creates its own event source. Use `share()` for multicast.
- **Blockable** - Temporarily pause event propagation without unsubscribing

```typescript
import { singlePointer } from "cereb";

const stream = singlePointer(element);

// Events only start flowing when you call on()
const unsubscribe = stream.on((signal) => {
  console.log(signal.value.x, signal.value.y);
});

// Temporarily pause events (useful during modal dialogs, etc.)
stream.block();

// Resume event flow
stream.unblock();

// Stop listening entirely
unsubscribe();
```

## Operators

**Operators** are functions that transform Streams. They take a Stream as input and return a new Stream with modified behavior.

### Composing with pipe()

The `pipe()` function chains operators together, creating readable data transformation pipelines:

```typescript
import { pipe, singlePointer } from "cereb";
import { filter, throttle, offset } from "cereb/operators";

pipe(
  singlePointer(element),
  filter((s) => s.value.pointerType === "touch"),
  throttle(16),
  offset({ target: canvas }),
).on((signal) => {
  // Only touch events, throttled to ~60fps, with canvas-relative coordinates
});
```

## Session

A **Session** represents a bounded sequence of events with a clear start and end. For pointer input, a session typically spans from `start` (pointer down) to `end` (pointer up) or `cancel`.

```typescript
import { pipe, singlePointer } from "cereb";
import { singlePointerSession } from "cereb/operators";

pipe(
  singlePointer(element),
  singlePointerSession(),  // Only emit during active pointer sessions
).on((signal) => {
  // signal.value.phase is "start" | "move" | "end" | "cancel"
});
```

## Gesture Recognition

Cereb separates raw input handling from gesture recognition. The **cereb** package provides normalized pointer input, while gesture packages (like **@cereb/pan**) interpret that input as higher-level gestures.

```text
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Pointer/Touch  │────▶│  SinglePointer  │────▶│   Pan Gesture   │
│     Events      │     │     Signal      │     │     Signal      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      Raw DOM              Normalized              Interpreted
```
